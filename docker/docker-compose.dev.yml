# docker-compose.dev.yml - Local development backend with dashboard
#
# This is SEPARATE from the integration test infrastructure (which uses direct docker run).
# Use this for interactive development with persistent data and a web dashboard.
#
# Ports:
#   - 3220: Backend API (different from test port 3210)
#   - 3221: HTTP Actions
#   - 6791: Dashboard UI
#
# Volume: convex-es-dev-data (persistent across restarts)
#
# Commands:
#   just dev          - Start everything (backend, dashboard, frontend, ladle)
#   just dev-start    - Start only Docker services
#   just dev-stop     - Stop Docker services (preserves data)
#   just dev-reset    - Wipe all data and restart
#   just dev-deploy   - Deploy app to local backend
#   just dev-dashboard - Open dashboard in browser

services:
  backend:
    image: ghcr.io/get-convex/convex-backend:latest
    container_name: convex-es-dev-backend
    ports:
      - "3220:3210"
      - "3221:3211"
    environment:
      - INSTANCE_SECRET=${CONVEX_INSTANCE_SECRET:-0135d8598650f8f5cb0f30c34ec2e2bb62793bc28717c8eb6fb577996d50be5f}
      - IS_TEST=false
      - CONVEX_CLOUD_ORIGIN=http://127.0.0.1:3210
      - CONVEX_SITE_ORIGIN=http://127.0.0.1:3211
      # Note: Container env vars do NOT reach Convex "use node" actions.
      # The dev-set-openrouter-key Justfile recipe sets this via `convex env set` instead.
      # Kept for reference only.
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
    volumes:
      - convex-es-dev-data:/convex_data
    shm_size: 256m
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3210/"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  dashboard:
    image: ghcr.io/get-convex/convex-dashboard:latest
    container_name: convex-es-dev-dashboard
    ports:
      - "6791:6791"
    environment:
      - CONVEX_BACKEND_URL=http://backend:3210
    depends_on:
      backend:
        condition: service_healthy

volumes:
  convex-es-dev-data:
    name: convex-es-dev-data
